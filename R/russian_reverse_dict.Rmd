---
title: "逆引きロシア単語辞書作成とその活用"
author: "Ryo Yamada"
date: "2021/12/23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ロシア語単語の逆引き

ロシア語単語は活用が難しい。

難しすぎて、普通のロシア語辞書を引くことすらできない。

まずは、語尾を見て、品詞が何で、その性・格・時世・能動/受動の区別をすることで、普通の辞書を引くとっかかりが得られるのではないかと考えた。

オンライン辞書のYarukuでは、たくさんの単語がその活用形とともに表示できるので、Yaruku辞書の出力をある程度テキストファイルにしてストックし、

-   テキストファイルのセットから、逆引き辞書用のデータベースRオブジェクトを作る

-   そのRオブジェクトに逆引き検索コマンドを発行して、語尾から得られる情報を得る

という2段階にしてみる

## データベースオブジェクトの作成

### Yaruku辞書検索出力の書式

冒頭には検索した文字列が、多彩な変化体のどれに合致するかの情報が提示されるが、今回の作業では、その情報は不要。

情報行にキリル文字列がある行は、 文字列変化の情報行。 その行には、その文字列に限った情報が書かれている。

キリル文字列がない行は、キリル文字列に関する情報のうち、 複数のキリル文字列に関する情報を提供する。

後になって、同類の情報が提供された場合には、上書きされるべき情報である。

### 

```{r}
library(stringr)
library(stringi)
library(readr)
library(Dict)
```

```{r}
gr.info <- list(c("代名詞","名詞","形容詞","形動詞","動詞"),c("一人称","二人称","三人称"),c("単数","複数"),c("男性","女性","中性"),c("現在","過去","未来"))
```

### 情報開始行の番数を返す

```{r}

my.line.number.info <- function(str,sep,gr.info){
  sep1 <- unlist(strsplit(str,sep))
  hinshi.line <- 0
  
  for(i in 1:length(sep1)){
    if(is.element(sep1[i],gr.info[[1]])){
      hinshi.line <- i
      hinshi <- sep1[i]
      break
    }
  }
  return(i)
}
```

### 入力情報の各行を指定セパレータ区切りで分割し、 各行をリストにして格納する

```{r}
my.make.list.with.separation <- function(str,start.line=1,sepa="\n",sepb=" "){
  sep1 <- unlist(strsplit(str,sepa))
  sep2 <- list()
  for(i in start.line:length(sep1)){
    sep2[[i-start.line+1]] <- unlist(strsplit(sep1[i],sepb))
  }
  return(sep2)
}
```

### 情報行をそれぞれ読み込む。

キリル文字なしの行(要素数が１の行)は、タンデムな文字列ベクトルとする。 その文字列ベクトルを、キリル文字ありの行の登録情報として使う。

キリル文字ありの行は、各行を登録用にリスト要素とする。

一番最初のキリル文字ありの行のキリル文字列は、「複数のキリル文字列を『束ねる基本形』として取出し、各キリル文字列の情報として登録する。

```{r}
my.make.list.of.words <- function(str,sepa="\r\n",sepb=" ",gr.info){
  info.ve <- c()
  root.word <- c()
  root.yet <- TRUE
  ret <- list()
  nt <- 1 # retリストの要素番号カウンタ
  info.line.num <- my.line.number.info(str,sep=sepa,gr.info=gr.info)
  infos <- my.make.list.with.separation(str,start.line=info.line.num,sepa,sepb)
  for(ii in 1:length(infos)){
    for(i in 1:length(gr.info)){
      for(j in 1:length(gr.info[[i]])){
        tmp <- gr.info[[i]][j]
        tmp2 <- paste(i,tmp,sep="_")
        infos[[ii]] <-gsub(tmp,tmp2,infos[[ii]])
      }
    }
  }
  for(i in 1:length(infos)){
    if(length(infos[[i]]) == 1){
      info.ve <- c(info.ve,infos[[i]][1])
    }else{
      if(root.yet){
        root.word <- infos[[i]][2]
        root.yet <- FALSE
      }
      tmp.info1 <- my.info.select(info.ve,gr.info)
      ret[[nt]] <- list(word=infos[[i]][2],kaku=infos[[i]][1],info1=tmp.info1,info2=infos[[i]][3],repword=root.word)
      nt <- nt+1
    }
  }
  return(ret)
}
```

info1 として登録した情報は、上書きしていかないといけないので、その処理を後付けで行う。

```{r}




my.info.select <- function(x,gr.info){
  ret <- c()
  for(i in 1:length(gr.info)){
    tmp <- rep(FALSE,length(length(x)))
    for(j in 1:length(gr.info[[i]])){
      tmp <- tmp | str_detect(x, pattern=gr.info[[i]][j])
    }
    s <- which(tmp)
    if(length(s)>1){
      x <- c(x[-s],x[max(s)])
    }
    
  }
  return(x)
}
```

## 語尾から検索

```{r}
my.search.tail <- function(w,dict,tocheck=nchar(w)){
  d.w <- sapply(dict,function(d){d$word})
  len <- nchar(w)

  ret <- list()
  for(i in 1:length(tocheck)){
    ret[[i]] <- c()
    tmp <- lapply(d.w,function(x){tmp.len <- nchar(x);return(substr(x,(tmp.len-tocheck[i]+1),tmp.len))})
    target <- substr(w,len-tocheck[i]+1,len)
    tmp2 <- sapply(tmp,function(x){return(x==target)})
    ret[[i]] <- which(tmp2)
  }
  return(ret)
}
```

## 結果の表示

```{r}
## Default
#out.sep1 = "::"
#out.sep2 = "_"
my.search.string <- function(word,out.sep1="::",out.sep2 = "_"){
  sorted.info1 <- sort(word$info1)
  sorted.info2 <- sort(word$info2)
  s.concat.info1 <- paste(sorted.info1,collapse=",")
  s.concat.info2 <- paste(sorted.info2,collapse=",")
  ret <- paste(s.concat.info1,out.sep1,s.concat.info2,out.sep1,word$word,word$repword,sep=out.sep2)
  return(ret)
}
my.display <- function(dict,ids){
  ret <- c()
  for(i in 1:length(ids)){
    tmp <- dict[[ids[i]]]
    ret <- c(ret,my.search.string(tmp))
  }
  return(ret)
}
```

```{r}
my.summary.tail.stat <- function(w,dict,tocheck=nchar(w)){
  out <- my.search.tail(w,dict,tocheck=tocheck)
  out. <- unlist(out)
  info1s <- info2s <- c()
  #for(i in 1:length(out[[1]])){
  for(i in 1:length(out.)){
    #wd <- dict[[out[[1]][i]]]
    word <- dict[[out.[i]]]
    sorted.info1 <- sort(word$info1)
    sorted.info2 <- sort(word$info2)
    s.concat.info1 <- paste(sorted.info1,collapse=",")
    s.concat.info2 <- paste(sorted.info2,collapse=",")
    info1s <- c(info1s,s.concat.info1)
    info2s <- c(info2s,s.concat.info2)
  }
  tabout1 <- table(info1s)
  tabout2 <- table(info2s)

  return(list(tabout1,tabout2))
}
my.summary.tail <- function(w,dict,tocheck=nchar(w)){
  out <- my.search.tail(w,dict,tocheck=tocheck)
  out. <- unlist(out)
  #ret <- my.display(dict,out[[1]])
  ret <- my.display(dict,out.)
  return(ret)
}
```

```{r}
my.print.stat <- function(stat.out,label1 = "info1",label2="info2"){
  print(label1)
  ord1 <- order(stat.out[[1]],decreasing=TRUE)
  for(i in 1:length(stat.out[[1]])){
    print(stat.out[[1]][ord1[i]])
  }
  print(label2)
  ord2 <- order(stat.out[[2]],decreasing=TRUE)
  for(i in 1:length(stat.out[[2]])){
    print(stat.out[[2]][ord2[i]])
  }
}
```

## たくさんのファイルを保存して、それを読み込み語尾から検索のデータベースオブジェクトを作る

```{r}
my.make.database <- function(pth,gr.info,f.ext="*.txt",sepa = "\r\n",sepb=" ",out.sep="_"){
  filenames <- list.files(pth, pattern=f.ext, full.names=TRUE)
  ldf <- lapply(filenames, read_file)
  ldf <- lapply(ldf,function(x){gsub("、",",",x)})
  
  res <- lapply(ldf,my.make.list.of.words,sepa=sepa,sepb=sepb,gr.info=gr.info)
  RES <- list()
  nt <- 1
  for(i in 1:length(res)){
    for(j in 1:length(res[[i]])){
      RES[[nt]] <- res[[i]][[j]]
      nt <- nt + 1
    }
  }
  return(RES)
}

```

## ファイルフォルダのパスを与えて、データベースオブジェクトを作る

```{r}
# ファイル・フォルダのパス
pth <- "C:/Users/Ryo Yamada/Desktop/Yakuru/"
#### Defaults
# ファイルの拡張子
#f.ext <- "*.txt"
# separators
#sepa = "\r\n"
#sepb = " "
#out.sep1 = "::"
#out.sep2 = "_"

my.inv.database <- my.make.database(pth=pth,gr.info=gr.info)
```

## 検索する

```{r}
wordtail <- "цветы"
tails <- my.summary.tail(wordtail,my.inv.database,tocheck=c(1,2,3,4,5))
stat.out <- my.summary.tail.stat(wordtail,my.inv.database,tocheck=c(1,2,3,4,5))
my.print.stat(stat.out)
out0 <- my.search.tail(wordtail,my.inv.database,tocheck=c(1,2,3,4,5))

out0.unlist <- unlist(out0)
k <- 5
for(i in 1:k){
  print("----")
  print(my.inv.database[[out0.unlist[length(out0.unlist)-i+1]]])
}


```

```{r}
out0 <- my.search.tail("Профессор",my.inv.database,tocheck=c(1,2,3))
out <- my.search.tail("вила",my.inv.database)
```
