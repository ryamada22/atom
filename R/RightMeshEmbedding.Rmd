---
title: "正三角形メッシュの3次元埋め込みの助走"
author: "ryamada"
date: "2019年12月13日"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 正三角形メッシュの3次元埋め込み

頂点数がn個あるとき、n個の頂点をn次元空間の正規直交基底の長さ$1/\sqrt{2}$の基底ベクトルの先端に取り、n次元空間で三角メッシュを構成することとする。

この空間では、すべての頂点間距離が1になるので、この三角メッシュはn次元空間に存在する正三角形メッシュであり、その多様体次元は2次元である。

このn次元メッシュを線形変換で3次元に埋め込みたい。

3次元埋め込みを考える前に、2次元アナロジーを考えることにする

## 単位線分が作る多面体の2次元埋め込み

正三角形メッシュの3次元埋め込みの次元を1つ下げることにする。

正三角形は、単位線分になる。

閉多面体メッシュは、閉多角形になる。

埋め込み先空間は2次元になる。

埋め込み前空間はn次元空間になる。

### n次元から2次元への埋め込み行列の例を算出する

n次元空間の頂点座標は、埋め込みによらず同一である。

```{r}
n <- 7
Xn <- diag(rep(1/sqrt(2),n))
Xn
```

どのような埋め込み行列が、うまく埋め込みを実現するのかがわからないので、2次元埋め込み座標が与えられたときに、それを実現する行列を算出することを考える。

### 2次元単位長辺多角形座標

n辺からなる単位長辺多角形座標を以下の手順で作る。

n-2本の辺で、2次元折れ線を作る。

作る際に、両端点間距離が2以下になるように工夫をする。

距離が2以下であれば、2本の単位線分で連結する方法は2つある(距離がちょうど2のときは1つ)ので、そのようにして、単位長辺多角形座標を作る。

また、各辺のベクトル情報を返す(単位ベクトルである)。

```{r}
# nは多角形の頂点数
# まず、正n角形を作り、sを使ってそこから少しずらす
my.zitter.npoly <- function(n,s=0.5){
  # 正多角形の場合の、辺ベクトルを指定する角度を生成
	thetas <- 2*pi/n * (1:n)
	# 正多角形からずらす。角度だけをずらすことで辺の長さは1のまま
	thetas <- thetas + rnorm(n) * s
	# エッジベクトルを作る(単位ベクトル)
	edges <- cbind(cos(thetas),sin(thetas))
	# 頂点座標は、エッジベクトルの累積和
	# 1...,n-2頂点まで決める
	X <- apply(edges[1:(n-2),],2,cumsum)
	# n番頂点は、元に戻るので、原点
	xn <- c(0,0)
	# n-2番頂点座標を取り出す
	xn_2 <- X[n-2,]
	# n-1番頂点座標は、n-2番頂点とn番頂点との中点から
	# (n-2)---nベクトルに直交するベクトル方向に、適当な長さで離れた点になる
	# (n-2)---n間距離
	d <- sqrt(sum((xn-xn_2)^2))
	# 直交ベクトル
	perp <- c(xn_2[2],-xn_2[1])
	# n-1番頂点座標
	k <- sqrt(1-(d/2)^2) / sqrt(sum(perp^2))
	xn_1 <- xn_2/2 + k * perp
	# 全頂点座標を行列化
	X <- rbind(X,xn_1,xn)
	# 全辺のベクトルを算出
	edges <- apply(X[c(1:n,1),],2,diff)
	return(list(X=X,edges=edges))
}
```

```{r}
n <- 7
outz <- my.zitter.npoly(n)
X2 <- outz$X
plot(X2)
segments(X2[,1],X2[,2],X2[c(2:n,1),1],X2[c(2:n,1),2])
```

隣接頂点間距離が1であることを確認する。

出力の対角部分と、左隅が1であることでわかる。

```{r}
dist(X2)
```

### 変換行列を求める

n次元座標Xnと、対応する2次元座標X2がある。

また、n次元空間でのn本の辺ベクトルの行列Enと、対応する2次元空間でのn本の辺ベクトル行列E2がある。

さて、この埋め込み変換Mで「不変」にしたいのは、n本の辺の長さであるから、



$$
M E_n = E_2\\
M = E_2 E_n^{-1}
$$

$E_n$はランクがnではない(閉じているという制約のため)ので、$E_n^{-1}$を一般化逆行列として求めることとする。

```{r}
library(matlib)
my.embed2 <- function(E2){
  En <- matrix(0,n,n)
  diag(En) <- 1
  for(i in 1:n){
	  if(i==1){
		  En[i,n] <- -1
	  }else{
		  En[i,i-1] <- -1
	  }
  }
  En <- En / sqrt(2)
  E2 <- rbind(t(E2),matrix(0,n-2,n))

  M <- E2 %*% Ginv(En)
  return(M)
}
```

```{r}
M <- my.embed2(outz$edges)
```

このMをn次元正規直交基底座標 Xnに作用させてみる。

```{r}
X2.embed <- M %*% Xn
X2.embed. <- t(X2.embed)[,1:2]
```

2次元多角形と、埋め込み後2次元多角形をプロットしてみる。
```{r}
plot(rbind(X2,X2.embed.),col=rep(1:2,each=n))
segments(X2[,1],X2[,2],X2[c(2:n,1),1],X2[c(2:n,1),2])
segments(X2.embed.[,1],X2.embed.[,2],X2.embed.[c(2:n,1),1],X2.embed.[c(2:n,1),2],col=2)
```

X2と埋め込みX2との距離行列が同じであることを確認する。

```{r}
range(as.matrix(dist(X2))-as.matrix(dist(X2.embed.)))
```

### 埋め込み行列の性質を考察する

埋め込み行列の算出に成功したので、その行列の性質を検討しておく。

ランクは2。

```{r}
eigen.out <- eigen(M)
eigen.out[[1]]
plot(eigen.out[[1]],type="b")
```

辺の数だけベクトル長が１になる制約がある。

ただし、辺ベクトルの総和が0ベクトルになるという制約があるので、その分だけ制約は少ない～自由度は高い。

```{r}
sum((M %*% c(-1,1,rep(0,n-2)/sqrt(2))^2))
```